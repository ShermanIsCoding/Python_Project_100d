===复制===

主要内容：

```
1. 复制的使用方式，如何建立或断开复制、安全性、只读等。
2. 复制可支持的拓扑结构，以及每个拓扑结构的适用场景。
3. 分析复制的原理，包括建立复制、全量复制、部分复制、心跳等。
4. 常见问题：读写分离、数据不一致，规避全量复制等。
```

===建立复制===

```
三种方式建立复制：
1. 在配置文件中加入slaveof{masterHost}{masterPort}
2. 在redis-server启动命令后加入--slave{masterHost}{masterPort}
3. 直接使用命令：slaveof{masterHost}{masterPort}

但是注意：slaveof配置都是在从节点发起。slaveof命令本身是异步命令，执行slaveof命令
时，节点只保存主节点信息后返回，后续复制流程在节点内部异步执行。
```

===断开复制===

```
断开复制流程：
1. 断开与主节点复制关系
2. 从节点晋升为主节点

说明：slaveof no one从节点断开复制后并不会抛弃原有数据，只是无法再获取主节点上的
数据变化。
```

===切主操作===

```
1. 断开与旧主节点复制关系
2. 与新主节点建立复制关系
3. 删除从节点当前所有数据
4. 对新主节点进行复制操作

注意：切主后从节点会清空之前所有的数据！
```

总的来说：由于复制只能从主节点到从节点，对于从节点的任何修改主节点都无法感知。

修改从节点会造成主从数据不一致。

===拓扑===

Redis的复制拓扑结构可以支持单层或多层复制关系，根据拓扑复杂性可以分为以下三种：

一主一从、一主多从、树状主从结构。

```
一主多从
又称为星形拓扑结构，使得应用端可以利用多个从节点实现读写分离。
```

```
树状主从结构
树状拓扑结构使得从节点不但可以复制主节点数据，同时可以作为其他从节点的主节点继续向
下层复制。通过引入复制中间层，可以有效降低主节点负载和需要传送给从节点的数据量。

当主节点需要挂载多个从节点时为了避免对主节点的性能干扰，可以采用树状主从结构降低
主节点压力。
```

===复制原理===

```
详细的复制过程：
1. 保存主节点信息
2. 主从建立socket连接
3. 发送ping命令
4. 权限验证
5. 同步数据集
6. 命令持续复制

说明：发送ping命令的目的：a.检测主从之间网络套接字是否可用 b.检测主节点当前是否可
接受处理命令。
```

数据同步

```
1. 全量复制
也就是会把主节点全部数据一次性发送给从节点，当数据量较大是，会对主从节点和网络
造成很大开销。一般场景：初次复制。
2. 部分复制
用于处理在主从复制中因网络闪断等原因造成的数据丢失场景，当从节点再次连上主节点后
如果条件允许，主节点会补发丢失数据给从节点。

通过对比主从节点的复制偏移量，可以判断主从节点数据是否一致。信息保存在
info replication命令下的相关字段中。
```

